name: Pytest Workflow

on:
  push:
    branches: [ main ]  # Runs on push to main branch
  pull_request:
    branches: [ main ]  # Runs on pull requests to main
  schedule:
    - cron: '0 0 * * *'  # Runs at 00:00 UTC every day
  workflow_dispatch:  # Allows manual triggering

jobs:
  build_and_test:
    runs-on: ubuntu-latest  # Specifies the runner environment
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']  # Test on multiple Python versions
      fail-fast: false  # Continue testing other versions even if one fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gfortran \
          libqt5gui5 libqt5widgets5 libqt5core5a \
          qt5-qmake qtbase5-dev \
          xvfb x11-utils libxkbcommon-x11-0 libxcb-icccm4 \
          libxcb-image0 libxcb-keysyms1 libxcb-randr0 \
          libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-timeout pytest-xdist
        pip install -r requirements.txt

    - name: Compile Helmholtz EOS
      run: |
        cd _helmholtz
        make clean
        make
        cd ..

    - name: Verify Helmholtz executable
      run: |
        test -f _helmholtz/helmholtz.exe
        _helmholtz/helmholtz.exe False 1.0e6 1.0e9 16.0 8.0

    - name: Run unit tests with coverage
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        export QT_QPA_PLATFORM=offscreen
        xvfb-run -a pytest _testing/test_aux.py _testing/test_cleanup.py _testing/test_self_heat.py -v --cov=. --cov-report=xml --cov-report=term

    - name: Run integration tests
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        export QT_QPA_PLATFORM=offscreen
        xvfb-run -a pytest _testing/test_self_heat_integration.py -v --timeout=300

    - name: Run all tests with detailed output
      run: |
        export PYTHONPATH="${PYTHONPATH}:$(pwd)"
        export QT_QPA_PLATFORM=offscreen
        xvfb-run -a pytest -v --tb=short --maxfail=5

    - name: Upload coverage reports
      if: matrix.python-version == '3.10'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Test cleanup script
      run: |
        python cleanup.py
        test ! -f abundances.png || echo "abundances.png was not cleaned up"
        test ! -f detonation_lengths.png || echo "detonation_lengths.png was not cleaned up"

    - name: Archive test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-outputs-py${{ matrix.python-version }}
        path: |
          *.png
          *.dat
          coverage.xml
        retention-days: 7

  test-coverage-report:
    runs-on: ubuntu-latest
    needs: build_and_test
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Generate coverage summary
      run: |
        echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "Coverage reports have been generated and uploaded." >> $GITHUB_STEP_SUMMARY

